# 智慧小区生活平台 - 线上部署指南

## 📅 更新时间
2024-06-03

## 🎯 部署概述

本指南将帮助您将本地开发的智慧小区生活平台部署到线上环境。我们使用 **Render.com** 作为部署平台，它提供免费的托管服务，支持自动部署和环境变量配置。

### 🏗️ 部署架构
- **前端**: Render Static Site (免费)
- **后端**: Render Web Service (免费)
- **数据库**: SQLite (文件存储)
- **邮件服务**: QQ邮箱 SMTP
- **短信服务**: 阿里云SMS

## 📋 部署前准备

### 1. 检查本地配置

确保以下功能在本地正常工作：
- [x] 邮箱验证码发送正常
- [x] API端点连接正常
- [x] 前端构建成功
- [x] 后端编译成功

### 2. 环境配置文件调整

#### 后端环境配置

**生产环境配置** (`backend/.env`)：
```bash
# 生产环境配置
NODE_ENV=production
PORT=3000

# JWT配置
JWT_SECRET=smart-community-super-secret-jwt-key-2024-production
JWT_EXPIRES_IN=7d

# 数据库配置
DATABASE_PATH=./data/smart-community.db

# CORS配置 - 需要更新为实际的前端URL
FRONTEND_URL=https://your-frontend-app.onrender.com

# 邮箱服务配置
EMAIL_HOST=smtp.qq.com
EMAIL_PORT=587
EMAIL_SECURE=false
EMAIL_USER=1217112842@qq.com
EMAIL_PASS=tfxjopirvegaidih
EMAIL_FROM=1217112842@qq.com
EMAIL_ENABLED=true

# 短信服务配置
SMS_ENABLED=true
SMS_PROVIDER=aliyun
ALIBABA_CLOUD_ACCESS_KEY_ID=your-alibaba-access-key-id
ALIBABA_CLOUD_ACCESS_KEY_SECRET=your-alibaba-access-key-secret
SMS_SIGN_NAME=智慧小区
SMS_TEMPLATE_CODE=SMS_319401912

# 文件上传配置
UPLOAD_DIR=./uploads
MAX_FILE_SIZE=5242880

# 日志级别
LOG_LEVEL=info
```

#### 前端环境配置

**生产环境配置** (`frontend/.env.production`)：
```bash
# 生产环境配置
VITE_APP_ENV=production
VITE_API_BASE_URL=https://your-backend-app.onrender.com/api
VITE_APP_NAME=智慧小区生活平台
```

## 🚀 部署步骤

### 第一步：准备GitHub仓库

1. **确保代码已推送到GitHub**：
```bash
git add .
git commit -m "准备线上部署：更新环境配置"
git push origin main
```

2. **检查.gitignore文件**：
确保敏感文件不会被提交：
```gitignore
# 环境变量文件
.env.local
.env.development.local
.env.test.local
.env.production.local

# 数据库文件
*.db
*.sqlite
*.sqlite3

# 日志文件
logs/
*.log

# 依赖目录
node_modules/
dist/
build/

# 上传文件
uploads/
```

### 第二步：部署后端服务

#### 1. 创建Render Web Service

1. 访问 [Render.com](https://render.com) 并登录
2. 点击 **"New +"** → **"Web Service"**
3. 连接您的GitHub账户并选择项目仓库
4. 配置服务设置：

**基本配置**：
- **Name**: `smart-community-backend`
- **Region**: `Singapore` (亚洲用户推荐)
- **Branch**: `main`
- **Root Directory**: `backend`
- **Runtime**: `Node`

**构建配置**：
- **Build Command**: `npm install && npm run build`
- **Start Command**: `npm start`

**高级配置**：
- **Node Version**: `18` (在环境变量中设置 `NODE_VERSION=18`)

#### 2. 配置环境变量

在Render Dashboard中，进入后端服务的 **Environment** 页面，添加以下环境变量：

```bash
NODE_ENV=production
PORT=3000
JWT_SECRET=smart-community-super-secret-jwt-key-2024-production
JWT_EXPIRES_IN=7d
DATABASE_PATH=./data/smart-community.db
EMAIL_HOST=smtp.qq.com
EMAIL_PORT=587
EMAIL_SECURE=false
EMAIL_USER=1217112842@qq.com
EMAIL_PASS=tfxjopirvegaidih
EMAIL_FROM=1217112842@qq.com
EMAIL_ENABLED=true
SMS_ENABLED=true
SMS_PROVIDER=aliyun
ALIBABA_CLOUD_ACCESS_KEY_ID=your-alibaba-access-key-id
ALIBABA_CLOUD_ACCESS_KEY_SECRET=your-alibaba-access-key-secret
SMS_SIGN_NAME=智慧小区
SMS_TEMPLATE_CODE=SMS_319401912
UPLOAD_DIR=./uploads
MAX_FILE_SIZE=5242880
LOG_LEVEL=info
```

#### 3. 部署后端

1. 点击 **"Create Web Service"**
2. 等待构建和部署完成（通常需要5-10分钟）
3. 记录后端服务的URL，格式为：`https://smart-community-backend.onrender.com`

### 第三步：部署前端服务

#### 1. 更新前端配置

在本地更新 `frontend/.env.production` 文件：
```bash
VITE_APP_ENV=production
VITE_API_BASE_URL=https://smart-community-backend.onrender.com/api
VITE_APP_NAME=智慧小区生活平台
```

提交更改：
```bash
git add frontend/.env.production
git commit -m "更新前端生产环境API地址"
git push origin main
```

#### 2. 创建Render Static Site

1. 在Render Dashboard中，点击 **"New +"** → **"Static Site"**
2. 选择同一个GitHub仓库
3. 配置服务设置：

**基本配置**：
- **Name**: `smart-community-frontend`
- **Branch**: `main`
- **Root Directory**: `frontend`

**构建配置**：
- **Build Command**: `npm install && npm run build`
- **Publish Directory**: `dist`

#### 3. 配置SPA路由重定向

创建 `frontend/public/_redirects` 文件：
```
/*    /index.html   200
```

这确保Vue Router的客户端路由正常工作。

#### 4. 部署前端

1. 点击 **"Create Static Site"**
2. 等待构建和部署完成
3. 记录前端服务的URL，格式为：`https://smart-community-frontend.onrender.com`

### 第四步：更新CORS配置

#### 1. 更新后端CORS设置

在后端服务的环境变量中更新：
```bash
FRONTEND_URL=https://smart-community-frontend.onrender.com
```

#### 2. 检查CORS代码

确保 `backend/src/index.ts` 中的CORS配置包含生产环境URL：
```typescript
const corsOptions = {
  origin: function (origin: string | undefined, callback: (err: Error | null, allow?: boolean) => void) {
    const allowedOrigins = [
      'http://localhost:5173',      // 开发环境
      'http://localhost:5174',      // 开发环境
      'https://smart-community-frontend.onrender.com', // 生产环境
      // 其他允许的域名...
    ];
    // ... CORS逻辑
  },
  credentials: true
};
```

## 🔧 部署后配置

### 1. 数据库初始化

由于使用SQLite，数据库文件会在首次运行时自动创建。如果需要初始化数据：

1. 通过Render Dashboard的Shell功能连接到后端服务
2. 运行数据库迁移命令（如果有的话）

### 2. 测试部署

#### API健康检查
```bash
curl https://smart-community-backend.onrender.com/health
```

#### 前端访问测试
访问：`https://smart-community-frontend.onrender.com`

#### 邮箱验证码测试
```bash
curl -X POST https://smart-community-backend.onrender.com/api/auth/send-verification-code \
  -H "Content-Type: application/json" \
  -d '{"identifier":"test@example.com","type":"email"}'
```

### 3. 监控和日志

- **后端日志**: 在Render Dashboard的后端服务页面查看
- **前端构建日志**: 在Render Dashboard的前端服务页面查看
- **错误监控**: 建议集成Sentry等错误监控服务

## 🔄 自动部署配置

### GitHub Actions自动部署

创建 `.github/workflows/deploy.yml`：
```yaml
name: Deploy to Render

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy Backend
        run: |
          curl -X POST ${{ secrets.RENDER_BACKEND_DEPLOY_HOOK }}
      
      - name: Deploy Frontend
        run: |
          curl -X POST ${{ secrets.RENDER_FRONTEND_DEPLOY_HOOK }}
```

在GitHub仓库设置中添加Secrets：
- `RENDER_BACKEND_DEPLOY_HOOK`: 后端服务的Deploy Hook URL
- `RENDER_FRONTEND_DEPLOY_HOOK`: 前端服务的Deploy Hook URL

## 🛠️ 常见问题解决

### 1. 构建失败

**问题**: Node.js版本不匹配
**解决方案**: 在环境变量中设置 `NODE_VERSION=18`

**问题**: 依赖安装失败
**解决方案**: 检查 `package.json` 中的依赖版本

### 2. 运行时错误

**问题**: 数据库连接失败
**解决方案**: 检查数据库路径和权限

**问题**: 邮件发送失败
**解决方案**: 验证邮箱配置和网络连接

### 3. CORS错误

**问题**: 前端无法访问后端API
**解决方案**: 
1. 检查CORS配置中的域名
2. 确保环境变量 `FRONTEND_URL` 正确
3. 重新部署后端服务

### 4. 静态文件404

**问题**: Vue Router路由刷新后404
**解决方案**: 确保 `_redirects` 文件存在且配置正确

## 📊 性能优化

### 1. 免费服务限制

**Render免费服务限制**：
- 15分钟无活动后休眠
- 每月750小时运行时间
- 512MB内存限制
- 共享CPU

### 2. 优化建议

**后端优化**：
- 启用gzip压缩
- 优化数据库查询
- 实现健康检查端点

**前端优化**：
- 启用代码分割
- 压缩静态资源
- 使用CDN（如果需要）

### 3. 保活策略

创建简单的保活脚本：
```bash
#!/bin/bash
# keep-alive.sh
while true; do
  curl https://smart-community-backend.onrender.com/health
  sleep 840  # 14分钟
done
```

## 🔐 安全配置

### 1. 环境变量安全

- 不要在代码中硬编码敏感信息
- 使用Render的环境变量功能
- 定期轮换API密钥

### 2. HTTPS配置

Render自动提供HTTPS证书，无需额外配置。

### 3. 访问控制

- 配置适当的CORS策略
- 实现API速率限制
- 添加请求验证

## 📈 监控和维护

### 1. 健康检查

确保后端有健康检查端点：
```typescript
app.get('/health', (req, res) => {
  res.json({
    success: true,
    message: '智慧小区生活平台后端服务运行正常',
    timestamp: new Date().toISOString(),
    version: '1.0.0'
  });
});
```

### 2. 日志监控

- 使用结构化日志
- 监控错误率
- 设置告警通知

### 3. 备份策略

- 定期备份数据库文件
- 备份环境配置
- 版本控制代码

## 🎉 部署完成检查清单

部署完成后，请确认以下项目：

- [ ] 后端服务正常运行
- [ ] 前端页面可以访问
- [ ] API连接正常
- [ ] 邮箱验证码发送正常
- [ ] 短信验证码发送正常（如果配置）
- [ ] 用户注册流程正常
- [ ] 文件上传功能正常
- [ ] 数据库读写正常
- [ ] CORS配置正确
- [ ] HTTPS证书有效
- [ ] 自动部署配置正常

## 📞 技术支持

如果在部署过程中遇到问题，请：

1. 检查Render Dashboard中的部署日志
2. 查看本文档的常见问题部分
3. 参考Render官方文档
4. 检查GitHub仓库的Issues

## 🔗 相关链接

- [Render.com官方文档](https://render.com/docs)
- [项目GitHub仓库](https://github.com/your-username/smart-community)
- [前端部署地址](https://smart-community-frontend.onrender.com)
- [后端API地址](https://smart-community-backend.onrender.com)

---

**注意**: 
- 首次部署可能需要较长时间，请耐心等待
- 免费服务有使用限制，生产环境建议升级到付费计划
- 定期检查和更新依赖包的安全性
- 保持环境变量的安全性，不要泄露敏感信息 