# 智慧社区项目 - 外部访问配置指南

## 问题背景

用户反映智慧社区项目只能在开发机器上访问，换个电脑就无法获取到列表信息。这是因为：

1. 前端API配置可能指向了localhost
2. 后端CORS配置限制了访问来源
3. 服务器网络绑定配置不正确

## 解决方案

### 1. 后端配置优化

#### CORS配置更新
修改 `backend/src/index.ts` 中的CORS配置，支持动态允许所有来源：

```typescript
// 自定义CORS中间件 - 更宽松的配置用于外部访问
app.use((req, res, next) => {
  const origin = req.headers.origin;
  
  // 检查是否是生产环境且配置了允许所有来源
  const allowAllOrigins = process.env.FRONTEND_URL === '*' || process.env.NODE_ENV === 'development';
  
  if (allowAllOrigins) {
    // 允许所有来源
    res.header('Access-Control-Allow-Origin', origin || '*');
    console.log(`CORS: Origin ${origin || 'none'}, allowed: true (all origins allowed)`);
  } else {
    // 原有的域名白名单逻辑...
  }
  
  // 设置CORS头部
  res.header('Access-Control-Allow-Methods', 'OPTIONS, GET, POST, PUT, DELETE, HEAD, PATCH');
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, X-Requested-With, Accept, Origin, Access-Control-Request-Method, Access-Control-Request-Headers');
  res.header('Access-Control-Allow-Credentials', 'true');
  res.header('Access-Control-Max-Age', '86400');
  
  // 处理预检请求
  if (req.method === 'OPTIONS') {
    console.log(`OPTIONS request for ${req.path} from origin: ${origin || 'none'}`);
    return res.status(204).end();
  }
  
  // 继续处理请求
  return next();
});
```

#### 网络绑定配置
确保后端服务监听所有网络接口：

```typescript
app.listen(availablePort, '0.0.0.0', () => {
  console.log(`🚀 智慧moma生活平台后端服务启动成功`);
  console.log(`📍 本地地址: http://localhost:${availablePort}`);
  console.log(`📍 公网地址: http://123.56.64.5:${availablePort}`);
  // ...
});
```

### 2. 前端配置优化

前端API服务已经支持动态IP检测：

```typescript
// 根据环境自动切换API地址
const getApiBaseUrl = (): string => {
  // 在开发环境中，根据当前访问的主机名确定API地址
  if (import.meta.env.DEV) {
    const currentHost = window.location.hostname;
    
    // 如果是通过IP地址访问，使用相同的IP地址访问后端
    if (currentHost !== 'localhost' && currentHost !== '127.0.0.1') {
      return `http://${currentHost}:3000/api`;  // 使用3000端口
    }
    
    // 默认使用localhost:3000
    return 'http://localhost:3000/api';
  }
  
  // 生产环境配置...
};
```

### 3. 外部访问启动脚本

创建了专门的外部访问启动脚本：

#### `start-external-access.sh`
- 自动检测服务器IP地址
- 配置CORS允许所有来源
- 前后端都监听所有网络接口
- 提供完整的访问信息

#### `stop-external-access.sh`
- 停止外部访问服务
- 清理PID文件和端口占用

#### `check-external-status.sh`
- 检查服务运行状态
- 验证端口占用情况
- 测试内外部访问

#### `test-external-api.sh`
- 全面测试API功能
- 验证CORS配置
- 检查前端页面访问

## 使用方法

### 启动外部访问服务

```bash
# 方法1: 使用专用脚本（推荐）
./start-external-access.sh

# 方法2: 手动启动
# 1. 构建项目
cd backend && npm run build && cd ..
cd frontend && npm run build && cd ..

# 2. 启动后端（允许所有来源）
cd backend
nohup env NODE_ENV=production PORT=3000 FRONTEND_URL=* node dist/index.js > ../logs/backend-external-$(date +%Y%m%d-%H%M%S).log 2>&1 &
echo $! > ../backend.pid

# 3. 启动前端
cd ../frontend
nohup serve -s dist -l 5173 > ../logs/frontend-external-$(date +%Y%m%d-%H%M%S).log 2>&1 &
echo $! > ../frontend.pid
```

### 检查服务状态

```bash
# 检查服务状态
./check-external-status.sh

# 测试API功能
./test-external-api.sh
```

### 停止服务

```bash
# 停止外部访问服务
./stop-external-access.sh
```

## 访问地址

### 移动端访问
- 前端应用: `http://123.56.64.5:5173`
- 后端API: `http://123.56.64.5:3000/api`

### 电脑端访问
- 前端应用: `http://localhost:5173`
- 后端API: `http://localhost:3000/api`

### 健康检查
- 后端健康: `http://123.56.64.5:3000/health`
- API健康: `http://123.56.64.5:3000/api/health`

## 演示账户

- **业主**: `resident@example.com` / `password123`
- **物业**: `property@example.com` / `property123`
- **管理员**: `admin@example.com` / `admin123`

## 技术要点

### 1. CORS配置
- 支持动态来源检测
- 环境变量控制访问策略
- 完整的预检请求处理

### 2. 网络绑定
- 后端监听 `0.0.0.0:3000`
- 前端使用serve工具提供静态文件服务
- 支持内外部访问

### 3. 环境隔离
- 开发环境：自动检测当前主机名
- 生产环境：使用环境变量配置
- 灵活的端口管理

### 4. 监控和维护
- PID文件管理进程
- 日志文件记录运行状态
- 健康检查端点
- 状态监控脚本

## 故障排除

### 1. 端口被占用
```bash
# 检查端口占用
lsof -i :3000
lsof -i :5173

# 释放端口
./stop-external-access.sh
```

### 2. CORS错误
- 检查 `FRONTEND_URL` 环境变量设置
- 查看后端日志中的CORS信息
- 确认请求来源是否被允许

### 3. 网络访问问题
- 检查防火墙设置
- 确认服务器安全组配置
- 验证网络连通性

### 4. 服务启动失败
```bash
# 查看日志
tail -f logs/backend-external-*.log
tail -f logs/frontend-external-*.log

# 检查进程状态
./check-external-status.sh
```

## 注意事项

1. **安全性**: 生产环境中应该配置具体的允许域名，而不是使用 `*`
2. **性能**: 大量并发访问时建议使用Nginx反向代理
3. **监控**: 建议设置服务监控和自动重启机制
4. **备份**: 定期备份数据库文件和上传的文件
5. **更新**: 代码更新后需要重新构建和重启服务

## 相关文件

- `start-external-access.sh` - 外部访问启动脚本
- `stop-external-access.sh` - 停止服务脚本
- `check-external-status.sh` - 状态检查脚本
- `test-external-api.sh` - API测试脚本
- `backend/src/index.ts` - 后端主文件（CORS配置）
- `frontend/src/services/apiService.ts` - 前端API服务配置 