# 阿里云短信服务配置指南

## 概述

本指南将帮助您配置阿里云短信服务，为智慧小区平台添加手机验证码功能。

## 1. 购买阿里云短信套餐包

### 1.1 登录阿里云控制台
1. 访问 [阿里云官网](https://www.aliyun.com)
2. 登录您的阿里云账户
3. 搜索"短信服务"并进入产品页面

### 1.2 开通短信服务
1. 点击"立即开通"
2. 同意服务协议
3. 完成实名认证（如未完成）

### 1.3 购买短信套餐包
推荐套餐：
- **1000条套餐**：50元（0.05元/条）- 适合测试
- **5000条套餐**：250元（0.05元/条）- 适合小规模使用
- **1.5万条套餐**：705元（0.047元/条）- 适合中等规模使用

购买步骤：
1. 在短信服务控制台点击"购买套餐包"
2. 选择"国内短信套餐包"
3. 选择合适的套餐规格
4. 完成支付

## 2. 申请短信签名

### 2.1 准备材料
- 企业营业执照（企业用户）
- 个人身份证（个人用户，功能受限）
- 网站备案信息（如有）

### 2.2 申请流程
1. 进入短信服务控制台
2. 点击"签名管理" → "添加签名"
3. 填写签名信息：
   - 签名名称：智慧小区（或您的项目名称）
   - 签名来源：企业全称/网站/App等
   - 适用场景：验证码
4. 上传相关资质材料
5. 提交审核（通常1-2个工作日）

## 3. 申请短信模板

### 3.1 验证码模板
1. 点击"模板管理" → "添加模板"
2. 模板类型：验证码
3. 模板名称：注册验证码
4. 模板内容：`您的验证码是${code}，5分钟内有效，请勿泄露。`
5. 提交审核

### 3.2 模板变量说明
- `${code}`：验证码变量
- 模板必须包含"验证码"字样
- 必须说明有效期
- 必须包含安全提示

## 4. 获取API密钥

### 4.1 创建AccessKey
1. 进入阿里云控制台
2. 点击右上角头像 → "AccessKey管理"
3. 点击"创建AccessKey"
4. 记录AccessKey ID和AccessKey Secret

### 4.2 安全建议
- 不要在代码中硬编码密钥
- 使用环境变量存储密钥
- 定期轮换密钥
- 为短信服务创建专用的RAM用户

## 5. 配置项目环境变量

### 5.1 后端配置
在 `backend/.env` 文件中添加：

```bash
# 阿里云短信服务配置
ALIBABA_CLOUD_ACCESS_KEY_ID=your-access-key-id
ALIBABA_CLOUD_ACCESS_KEY_SECRET=your-access-key-secret
SMS_SIGN_NAME=智慧小区
SMS_TEMPLATE_CODE=SMS_123456789

# 短信服务配置
SMS_ENABLED=true
SMS_PROVIDER=aliyun
```

### 5.2 参数说明
- `ALIBABA_CLOUD_ACCESS_KEY_ID`：阿里云AccessKey ID
- `ALIBABA_CLOUD_ACCESS_KEY_SECRET`：阿里云AccessKey Secret
- `SMS_SIGN_NAME`：已审核通过的短信签名
- `SMS_TEMPLATE_CODE`：已审核通过的模板代码
- `SMS_ENABLED`：是否启用短信服务
- `SMS_PROVIDER`：短信服务提供商（aliyun/mock）

## 6. 安装依赖包

在后端项目目录执行：

```bash
npm install @alicloud/dysmsapi20170525 @alicloud/openapi-client @alicloud/tea-util
```

## 7. 测试配置

### 7.1 开发环境测试
1. 设置 `SMS_PROVIDER=mock` 进行模拟测试
2. 验证码会在控制台输出
3. 前端会显示验证码（仅开发环境）

### 7.2 生产环境测试
1. 设置 `SMS_PROVIDER=aliyun`
2. 使用真实手机号测试
3. 检查短信发送状态

## 8. 费用说明

### 8.1 计费方式
- 按发送成功的短信条数计费
- 发送失败不计费
- 套餐包优先抵扣

### 8.2 费用优化
- 设置发送频率限制
- 实现验证码缓存机制
- 监控异常发送行为
- 设置日发送量上限

## 9. 安全建议

### 9.1 验证码安全
- 验证码有效期不超过5分钟
- 同一手机号限制发送频率
- 验证成功后立即失效
- 记录发送日志

### 9.2 防刷机制
- IP限制：同一IP每小时最多发送10次
- 手机号限制：同一手机号每天最多发送5次
- 图形验证码：发送前验证图形验证码
- 黑名单机制：屏蔽异常手机号

## 10. 监控和运维

### 10.1 监控指标
- 短信发送成功率
- 验证码验证成功率
- 套餐包余量
- 异常发送统计

### 10.2 告警设置
- 套餐包余量不足告警
- 发送失败率过高告警
- 异常发送行为告警

## 11. 常见问题

### 11.1 签名审核失败
- 检查资质材料是否完整
- 确认签名内容符合规范
- 联系阿里云客服协助

### 11.2 模板审核失败
- 检查模板内容是否包含敏感词
- 确认变量格式正确
- 参考官方模板示例

### 11.3 发送失败
- 检查AccessKey是否正确
- 确认签名和模板已审核通过
- 检查手机号格式
- 查看错误码说明

## 12. 联系支持

- 阿里云工单系统
- 短信服务技术交流群
- 官方文档：https://help.aliyun.com/product/44282.html

---

**注意**：本指南基于阿里云短信服务最新版本编写，具体操作界面可能因版本更新而有所变化。 