# æ™ºæ…§å°åŒºç”Ÿæ´»å¹³å° - é˜¿é‡Œäº‘æœåŠ¡å™¨éƒ¨ç½²æŒ‡å—

## ðŸ“… æ›´æ–°æ—¶é—´
2024-06-03

## ðŸŽ¯ éƒ¨ç½²æ¦‚è¿°

æœ¬æŒ‡å—å°†å¸®åŠ©æ‚¨åœ¨é˜¿é‡Œäº‘æœåŠ¡å™¨ä¸Šç›´æŽ¥éƒ¨ç½²å’Œè¿è¡Œæ™ºæ…§å°åŒºç”Ÿæ´»å¹³å°ã€‚ç›¸æ¯”äº‘å¹³å°éƒ¨ç½²ï¼ŒæœåŠ¡å™¨éƒ¨ç½²æ›´åŠ çµæ´»ï¼Œå¯ä»¥å®Œå…¨æŽ§åˆ¶è¿è¡ŒçŽ¯å¢ƒã€‚

### ðŸ—ï¸ éƒ¨ç½²æž¶æž„
- **æœåŠ¡å™¨**: é˜¿é‡Œäº‘ECS
- **å‰ç«¯**: Nginx + Vue.jsé™æ€æ–‡ä»¶
- **åŽç«¯**: Node.js + PM2è¿›ç¨‹ç®¡ç†
- **æ•°æ®åº“**: SQLite (æ–‡ä»¶å­˜å‚¨)
- **é‚®ä»¶æœåŠ¡**: QQé‚®ç®± SMTP
- **çŸ­ä¿¡æœåŠ¡**: é˜¿é‡Œäº‘SMS

## ðŸ“‹ æœåŠ¡å™¨çŽ¯å¢ƒè¦æ±‚

### ç³»ç»Ÿè¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 20.04+ / CentOS 7+ / Debian 10+
- **å†…å­˜**: æœ€ä½Ž1GBï¼ŒæŽ¨è2GB+
- **å­˜å‚¨**: æœ€ä½Ž10GBå¯ç”¨ç©ºé—´
- **ç½‘ç»œ**: å…¬ç½‘IPï¼Œå¼€æ”¾80ã€443ã€3000ç«¯å£

### è½¯ä»¶ä¾èµ–
- Node.js 18+
- npm æˆ– yarn
- PM2 (è¿›ç¨‹ç®¡ç†)
- Nginx (WebæœåŠ¡å™¨)
- Git (ä»£ç ç®¡ç†)

## ðŸš€ å¿«é€Ÿéƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæœåŠ¡å™¨çŽ¯å¢ƒå‡†å¤‡

#### 1. è¿žæŽ¥æœåŠ¡å™¨
```bash
# ä½¿ç”¨SSHè¿žæŽ¥åˆ°æ‚¨çš„é˜¿é‡Œäº‘æœåŠ¡å™¨
ssh root@your-server-ip
# æˆ–ä½¿ç”¨å¯†é’¥æ–‡ä»¶
ssh -i your-key.pem root@your-server-ip
```

#### 2. æ›´æ–°ç³»ç»ŸåŒ…
```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS
sudo yum update -y
```

#### 3. å®‰è£…Node.js
```bash
# ä½¿ç”¨NodeSourceä»“åº“å®‰è£…Node.js 18
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# éªŒè¯å®‰è£…
node --version
npm --version
```

#### 4. å®‰è£…PM2
```bash
sudo npm install -g pm2
pm2 --version
```

#### 5. å®‰è£…Nginx
```bash
# Ubuntu/Debian
sudo apt install nginx -y

# CentOS
sudo yum install nginx -y

# å¯åŠ¨å¹¶è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl start nginx
sudo systemctl enable nginx
```

#### 6. å®‰è£…Git
```bash
# Ubuntu/Debian
sudo apt install git -y

# CentOS
sudo yum install git -y
```

### ç¬¬äºŒæ­¥ï¼šéƒ¨ç½²é¡¹ç›®ä»£ç 

#### 1. å…‹éš†é¡¹ç›®
```bash
# è¿›å…¥éƒ¨ç½²ç›®å½•
cd /opt

# å…‹éš†é¡¹ç›®ï¼ˆæ›¿æ¢ä¸ºæ‚¨çš„å®žé™…ä»“åº“åœ°å€ï¼‰
sudo git clone https://github.com/your-username/smart-community.git
cd smart-community

# è®¾ç½®ç›®å½•æƒé™
sudo chown -R $USER:$USER /opt/smart-community
```

#### 2. å®‰è£…ä¾èµ–
```bash
# å®‰è£…åŽç«¯ä¾èµ–
cd backend
npm install

# å®‰è£…å‰ç«¯ä¾èµ–
cd ../frontend
npm install
```

### ç¬¬ä¸‰æ­¥ï¼šé…ç½®çŽ¯å¢ƒå˜é‡

#### 1. é…ç½®åŽç«¯çŽ¯å¢ƒ
```bash
cd /opt/smart-community/backend

# å¤åˆ¶å¹¶ç¼–è¾‘ç”Ÿäº§çŽ¯å¢ƒé…ç½®
cp .env.example .env
nano .env
```

**ç”Ÿäº§çŽ¯å¢ƒé…ç½®** (`backend/.env`)ï¼š
```bash
# ç”Ÿäº§çŽ¯å¢ƒé…ç½®
NODE_ENV=production
PORT=3000

# JWTé…ç½®
JWT_SECRET=smart-community-super-secret-jwt-key-2024-production
JWT_EXPIRES_IN=7d

# æ•°æ®åº“é…ç½®
DATABASE_PATH=./data/smart-community.db

# CORSé…ç½® - ä½¿ç”¨æ‚¨çš„æœåŠ¡å™¨IPæˆ–åŸŸå
FRONTEND_URL=http://your-server-ip

# é‚®ç®±æœåŠ¡é…ç½®
EMAIL_HOST=smtp.qq.com
EMAIL_PORT=587
EMAIL_SECURE=false
EMAIL_USER=your-qq-email@qq.com
EMAIL_PASS=your-qq-smtp-password
EMAIL_FROM=your-qq-email@qq.com
EMAIL_ENABLED=true

# çŸ­ä¿¡æœåŠ¡é…ç½®
SMS_ENABLED=true
SMS_PROVIDER=aliyun
ALIBABA_CLOUD_ACCESS_KEY_ID=your-alibaba-access-key-id
ALIBABA_CLOUD_ACCESS_KEY_SECRET=your-alibaba-access-key-secret
SMS_SIGN_NAME=æ™ºæ…§å°åŒº
SMS_TEMPLATE_CODE=your-sms-template-code

# æ–‡ä»¶ä¸Šä¼ é…ç½®
UPLOAD_DIR=./uploads
MAX_FILE_SIZE=5242880

# æ—¥å¿—çº§åˆ«
LOG_LEVEL=info
```

#### 2. é…ç½®å‰ç«¯çŽ¯å¢ƒ
```bash
cd /opt/smart-community/frontend

# åˆ›å»ºç”Ÿäº§çŽ¯å¢ƒé…ç½®
cat > .env.production << EOF
# ç”Ÿäº§çŽ¯å¢ƒé…ç½®
VITE_APP_ENV=production
VITE_API_BASE_URL=http://your-server-ip:3000/api
VITE_APP_NAME=æ™ºæ…§å°åŒºç”Ÿæ´»å¹³å°
EOF
```

### ç¬¬å››æ­¥ï¼šæž„å»ºå’Œå¯åŠ¨æœåŠ¡

#### 1. æž„å»ºåŽç«¯
```bash
cd /opt/smart-community/backend
npm run build
```

#### 2. æž„å»ºå‰ç«¯
```bash
cd /opt/smart-community/frontend
npm run build
```

#### 3. å¯åŠ¨åŽç«¯æœåŠ¡
```bash
cd /opt/smart-community/backend

# ä½¿ç”¨PM2å¯åŠ¨åŽç«¯æœåŠ¡
pm2 start dist/index.js --name "smart-community-backend"

# ä¿å­˜PM2é…ç½®
pm2 save

# è®¾ç½®PM2å¼€æœºè‡ªå¯
pm2 startup
```

### ç¬¬äº”æ­¥ï¼šé…ç½®Nginx

#### 1. åˆ›å»ºNginxé…ç½®
```bash
sudo nano /etc/nginx/sites-available/smart-community
```

**Nginxé…ç½®æ–‡ä»¶**ï¼š
```nginx
server {
    listen 80;
    server_name your-server-ip your-domain.com;

    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        root /opt/smart-community/frontend/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # åŽç«¯APIä»£ç†
    location /api/ {
        proxy_pass http://localhost:3000/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # å¥åº·æ£€æŸ¥
    location /health {
        proxy_pass http://localhost:3000/health;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # é™æ€èµ„æºç¼“å­˜
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        root /opt/smart-community/frontend/dist;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

#### 2. å¯ç”¨ç«™ç‚¹é…ç½®
```bash
# åˆ›å»ºè½¯é“¾æŽ¥
sudo ln -s /etc/nginx/sites-available/smart-community /etc/nginx/sites-enabled/

# åˆ é™¤é»˜è®¤é…ç½®ï¼ˆå¯é€‰ï¼‰
sudo rm /etc/nginx/sites-enabled/default

# æµ‹è¯•Nginxé…ç½®
sudo nginx -t

# é‡å¯Nginx
sudo systemctl restart nginx
```

### ç¬¬å…­æ­¥ï¼šé…ç½®é˜²ç«å¢™

#### 1. å¼€æ”¾å¿…è¦ç«¯å£
```bash
# Ubuntu (ä½¿ç”¨ufw)
sudo ufw allow 22    # SSH
sudo ufw allow 80    # HTTP
sudo ufw allow 443   # HTTPS
sudo ufw allow 3000  # åŽç«¯æœåŠ¡ï¼ˆå¯é€‰ï¼Œç”¨äºŽç›´æŽ¥è®¿é—®ï¼‰
sudo ufw enable

# CentOS (ä½¿ç”¨firewalld)
sudo firewall-cmd --permanent --add-port=22/tcp
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp
sudo firewall-cmd --permanent --add-port=3000/tcp
sudo firewall-cmd --reload
```

#### 2. é˜¿é‡Œäº‘å®‰å…¨ç»„é…ç½®
åœ¨é˜¿é‡Œäº‘æŽ§åˆ¶å°é…ç½®å®‰å…¨ç»„è§„åˆ™ï¼š
- å…¥æ–¹å‘ï¼šå…è®¸80ç«¯å£ï¼ˆHTTPï¼‰
- å…¥æ–¹å‘ï¼šå…è®¸443ç«¯å£ï¼ˆHTTPSï¼‰
- å…¥æ–¹å‘ï¼šå…è®¸22ç«¯å£ï¼ˆSSHï¼‰
- å…¥æ–¹å‘ï¼šå…è®¸3000ç«¯å£ï¼ˆåŽç«¯APIï¼Œå¯é€‰ï¼‰

## ðŸ§ª æµ‹è¯•éƒ¨ç½²

### 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
```bash
# æ£€æŸ¥PM2è¿›ç¨‹
pm2 status

# æ£€æŸ¥NginxçŠ¶æ€
sudo systemctl status nginx

# æ£€æŸ¥ç«¯å£ç›‘å¬
sudo netstat -tlnp | grep :80
sudo netstat -tlnp | grep :3000
```

### 2. æµ‹è¯•APIè¿žæŽ¥
```bash
# å¥åº·æ£€æŸ¥
curl http://your-server-ip/health

# æµ‹è¯•é‚®ç®±éªŒè¯ç 
curl -X POST http://your-server-ip/api/auth/send-verification-code \
  -H "Content-Type: application/json" \
  -d '{"identifier":"test@example.com","type":"email"}'
```

### 3. è®¿é—®å‰ç«¯é¡µé¢
åœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼š`http://your-server-ip`

## ðŸ”§ è¿ç»´ç®¡ç†

### 1. æœåŠ¡ç®¡ç†å‘½ä»¤
```bash
# PM2å¸¸ç”¨å‘½ä»¤
pm2 list                    # æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹
pm2 restart smart-community-backend  # é‡å¯åŽç«¯æœåŠ¡
pm2 stop smart-community-backend     # åœæ­¢åŽç«¯æœåŠ¡
pm2 logs smart-community-backend     # æŸ¥çœ‹æ—¥å¿—
pm2 monit                   # ç›‘æŽ§é¢æ¿

# Nginxå¸¸ç”¨å‘½ä»¤
sudo systemctl restart nginx    # é‡å¯Nginx
sudo systemctl reload nginx     # é‡æ–°åŠ è½½é…ç½®
sudo nginx -t                   # æµ‹è¯•é…ç½®æ–‡ä»¶
```

### 2. æ—¥å¿—ç®¡ç†
```bash
# æŸ¥çœ‹åŽç«¯æ—¥å¿—
pm2 logs smart-community-backend

# æŸ¥çœ‹Nginxæ—¥å¿—
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# æŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—
sudo journalctl -u nginx -f
```

### 3. æ›´æ–°éƒ¨ç½²
```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/smart-community

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# æ›´æ–°åŽç«¯
cd backend
npm install
npm run build
pm2 restart smart-community-backend

# æ›´æ–°å‰ç«¯
cd ../frontend
npm install
npm run build

# é‡å¯Nginxï¼ˆå¦‚æžœéœ€è¦ï¼‰
sudo systemctl reload nginx
```

## ðŸ” å®‰å…¨é…ç½®

### 1. SSLè¯ä¹¦é…ç½®ï¼ˆæŽ¨èï¼‰
```bash
# å®‰è£…Certbot
sudo apt install certbot python3-certbot-nginx -y

# ç”³è¯·SSLè¯ä¹¦
sudo certbot --nginx -d your-domain.com

# è‡ªåŠ¨ç»­æœŸ
sudo crontab -e
# æ·»åŠ ä»¥ä¸‹è¡Œï¼š
# 0 12 * * * /usr/bin/certbot renew --quiet
```

### 2. ç³»ç»Ÿå®‰å…¨åŠ å›º
```bash
# ç¦ç”¨root SSHç™»å½•
sudo nano /etc/ssh/sshd_config
# è®¾ç½®ï¼šPermitRootLogin no

# åˆ›å»ºæ™®é€šç”¨æˆ·
sudo adduser deploy
sudo usermod -aG sudo deploy

# é…ç½®å¯†é’¥ç™»å½•
ssh-copy-id deploy@your-server-ip
```

### 3. æ•°æ®åº“å¤‡ä»½
```bash
# åˆ›å»ºå¤‡ä»½è„šæœ¬
cat > /opt/backup-db.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/opt/backups"
DB_PATH="/opt/smart-community/backend/data/smart-community.db"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR
cp $DB_PATH $BACKUP_DIR/smart-community_$DATE.db

# ä¿ç•™æœ€è¿‘7å¤©çš„å¤‡ä»½
find $BACKUP_DIR -name "smart-community_*.db" -mtime +7 -delete
EOF

chmod +x /opt/backup-db.sh

# è®¾ç½®å®šæ—¶å¤‡ä»½
crontab -e
# æ·»åŠ ï¼š0 2 * * * /opt/backup-db.sh
```

## ðŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. åŽç«¯ä¼˜åŒ–
```bash
# å¢žåŠ Node.jså†…å­˜é™åˆ¶
pm2 start dist/index.js --name "smart-community-backend" --node-args="--max-old-space-size=1024"

# å¯ç”¨é›†ç¾¤æ¨¡å¼
pm2 start dist/index.js --name "smart-community-backend" -i max
```

### 2. å‰ç«¯ä¼˜åŒ–
```nginx
# åœ¨Nginxé…ç½®ä¸­æ·»åŠ gzipåŽ‹ç¼©
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
```

### 3. ç³»ç»Ÿç›‘æŽ§
```bash
# å®‰è£…htop
sudo apt install htop -y

# ç›‘æŽ§ç³»ç»Ÿèµ„æº
htop

# ç›‘æŽ§ç£ç›˜ä½¿ç”¨
df -h

# ç›‘æŽ§å†…å­˜ä½¿ç”¨
free -h
```

## ðŸŽ‰ éƒ¨ç½²å®Œæˆæ£€æŸ¥æ¸…å•

éƒ¨ç½²å®ŒæˆåŽï¼Œè¯·ç¡®è®¤ä»¥ä¸‹é¡¹ç›®ï¼š

- [ ] æœåŠ¡å™¨çŽ¯å¢ƒé…ç½®æ­£ç¡®
- [ ] Node.jså’ŒPM2å®‰è£…æˆåŠŸ
- [ ] é¡¹ç›®ä»£ç å…‹éš†å®Œæˆ
- [ ] åŽç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ
- [ ] å‰ç«¯æž„å»ºæˆåŠŸ
- [ ] Nginxé…ç½®æ­£ç¡®
- [ ] é˜²ç«å¢™å’Œå®‰å…¨ç»„é…ç½®
- [ ] APIè¿žæŽ¥æ­£å¸¸
- [ ] é‚®ç®±éªŒè¯ç å‘é€æ­£å¸¸
- [ ] å‰ç«¯é¡µé¢å¯ä»¥è®¿é—®
- [ ] æ•°æ®åº“è¯»å†™æ­£å¸¸
- [ ] SSLè¯ä¹¦é…ç½®ï¼ˆå¦‚æžœéœ€è¦ï¼‰
- [ ] å¤‡ä»½ç­–ç•¥é…ç½®

## ðŸ› ï¸ å¸¸è§é—®é¢˜è§£å†³

### 1. ç«¯å£å ç”¨é—®é¢˜
```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
sudo lsof -i :3000
sudo lsof -i :80

# æ€æ­»å ç”¨è¿›ç¨‹
sudo kill -9 PID
```

### 2. æƒé™é—®é¢˜
```bash
# ä¿®å¤æ–‡ä»¶æƒé™
sudo chown -R $USER:$USER /opt/smart-community
chmod -R 755 /opt/smart-community
```

### 3. å†…å­˜ä¸è¶³
```bash
# åˆ›å»ºswapæ–‡ä»¶
sudo fallocate -l 1G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# æ°¸ä¹…å¯ç”¨
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

### 4. æœåŠ¡å¯åŠ¨å¤±è´¥
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—
pm2 logs smart-community-backend --lines 50

# æ£€æŸ¥é…ç½®æ–‡ä»¶
cat backend/.env

# æ‰‹åŠ¨å¯åŠ¨æµ‹è¯•
cd /opt/smart-community/backend
node dist/index.js
```

## ðŸ“ž æŠ€æœ¯æ”¯æŒ

å¦‚æžœåœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—å’Œé”™è¯¯ä¿¡æ¯
2. ç¡®è®¤é˜²ç«å¢™å’Œå®‰å…¨ç»„é…ç½®
3. éªŒè¯çŽ¯å¢ƒå˜é‡é…ç½®
4. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„å¸¸è§é—®é¢˜éƒ¨åˆ†

## ðŸ”— ç›¸å…³é“¾æŽ¥

- [PM2å®˜æ–¹æ–‡æ¡£](https://pm2.keymetrics.io/docs/)
- [Nginxå®˜æ–¹æ–‡æ¡£](https://nginx.org/en/docs/)
- [é˜¿é‡Œäº‘ECSæ–‡æ¡£](https://help.aliyun.com/product/25365.html)
- [é¡¹ç›®GitHubä»“åº“](https://github.com/your-username/smart-community)

---

**æ³¨æ„**: 
- è¯·æ ¹æ®å®žé™…æœåŠ¡å™¨IPå’ŒåŸŸåä¿®æ”¹é…ç½®
- è¯·å°†ç¤ºä¾‹ä¸­çš„æ•æ„Ÿä¿¡æ¯æ›¿æ¢ä¸ºæ‚¨çš„å®žé™…é…ç½®
- å®šæœŸæ›´æ–°ç³»ç»Ÿå’Œä¾èµ–åŒ…
- åšå¥½æ•°æ®å¤‡ä»½å’Œå®‰å…¨é˜²æŠ¤
- ç›‘æŽ§æœåŠ¡å™¨èµ„æºä½¿ç”¨æƒ…å†µ 