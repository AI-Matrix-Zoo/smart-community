# 智慧社区项目 - 500错误解决方案

## 🚨 问题描述

用户在使用智慧社区项目时遇到以下错误：

```
Failed to load resource: the server responded with a status of 500 (Internal Server Error)
添加市场物品失败: Error: 发布物品失败
```

## 🔍 问题诊断

### 错误日志分析

通过查看后端日志发现具体错误信息：

```
发布物品失败: [Error: SQLITE_ERROR: table market_items has no column named image_urls] {
  errno: 1,
  code: 'SQLITE_ERROR'
}
```

### 根本原因

数据库表结构不完整，`market_items` 表缺少 `image_urls` 列，导致在发布市场物品时出现SQL错误。

## 🛠️ 解决方案

### 1. 立即修复

**步骤1：添加缺失的数据库列**

```bash
# 进入后端目录
cd backend

# 添加image_urls列
sqlite3 data/community.db "ALTER TABLE market_items ADD COLUMN image_urls TEXT;"

# 验证修复
sqlite3 data/community.db ".schema market_items"
```

**步骤2：重启服务**

```bash
# 返回项目根目录
cd ..

# 重启外部访问服务
./external-manager.sh restart
```

### 2. 使用数据库修复脚本

我们提供了专门的数据库修复脚本：

```bash
# 检查数据库结构
./fix-database.sh --check

# 修复数据库结构（会自动备份）
./fix-database.sh --fix

# 仅备份数据库
./fix-database.sh --backup
```

## 📋 验证修复

### 1. 检查表结构

```bash
cd backend
sqlite3 data/community.db ".schema market_items"
```

应该看到包含 `image_urls TEXT` 的完整表结构。

### 2. 测试API功能

```bash
./external-manager.sh test
```

### 3. 前端功能测试

1. 访问 `http://123.56.64.5:5173`
2. 登录任意演示账户
3. 进入"闲置市场"页面
4. 尝试发布新物品
5. 确认可以成功上传图片和发布物品

## 🔧 预防措施

### 1. 数据库版本管理

为避免类似问题，建议：

- 定期备份数据库
- 使用数据库迁移脚本
- 在部署前检查表结构

### 2. 定期维护

```bash
# 每周运行一次数据库检查
./fix-database.sh --check

# 每月备份一次数据库
./fix-database.sh --backup
```

### 3. 监控和日志

- 定期查看后端日志：`./external-manager.sh logs backend`
- 监控服务状态：`./external-manager.sh status`
- 测试API功能：`./external-manager.sh test`

## 📊 技术细节

### 数据库表结构变更

**修复前的表结构：**
```sql
CREATE TABLE market_items (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  description TEXT NOT NULL,
  price REAL NOT NULL,
  category TEXT NOT NULL,
  image_url TEXT,
  seller TEXT NOT NULL,
  seller_user_id TEXT,
  posted_date DATETIME NOT NULL,
  contact_info TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (seller_user_id) REFERENCES users(id)
);
```

**修复后的表结构：**
```sql
CREATE TABLE market_items (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  description TEXT NOT NULL,
  price REAL NOT NULL,
  category TEXT NOT NULL,
  image_url TEXT,
  seller TEXT NOT NULL,
  seller_user_id TEXT,
  posted_date DATETIME NOT NULL,
  contact_info TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  image_urls TEXT,  -- 新增：支持多图片的JSON字符串
  FOREIGN KEY (seller_user_id) REFERENCES users(id)
);
```

### 代码逻辑

后端代码期望 `image_urls` 列存储JSON格式的图片URL数组：

```typescript
// 构建图片URL数组
const imageUrls = uploadedFiles.map(file => `/uploads/${file.filename}`);
const imageUrlsJson = JSON.stringify(imageUrls);

// 插入数据库
db.run(
  `INSERT INTO market_items (..., image_urls, ...)
   VALUES (..., ?, ...)`,
  [..., imageUrlsJson, ...]
);
```

## 🎯 相关工具

### 1. 数据库修复脚本

- **文件**: `fix-database.sh`
- **功能**: 检查和修复数据库表结构
- **用法**: `./fix-database.sh --help`

### 2. 外部访问管理脚本

- **文件**: `external-manager.sh`
- **功能**: 统一管理服务启动、停止、状态检查
- **用法**: `./external-manager.sh help`

### 3. 日志查看

```bash
# 查看后端日志
./external-manager.sh logs backend

# 查看前端日志
./external-manager.sh logs frontend

# 查看所有日志
./external-manager.sh logs
```

## 🚀 快速恢复指南

如果再次遇到类似问题：

1. **立即诊断**：
   ```bash
   ./external-manager.sh logs backend | tail -20
   ```

2. **检查数据库**：
   ```bash
   ./fix-database.sh --check
   ```

3. **修复问题**：
   ```bash
   ./fix-database.sh --fix
   ```

4. **重启服务**：
   ```bash
   ./external-manager.sh restart
   ```

5. **验证修复**：
   ```bash
   ./external-manager.sh test
   ```

## 📞 联系支持

如果问题仍然存在，请提供以下信息：

1. 错误日志：`./external-manager.sh logs backend`
2. 服务状态：`./external-manager.sh status`
3. 数据库结构：`./fix-database.sh --check`
4. 具体操作步骤和错误截图

---

**✅ 问题已解决！现在您可以正常使用市场物品发布功能了。** 