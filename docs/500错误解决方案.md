# æ™ºæ…§ç¤¾åŒºé¡¹ç›® - 500é”™è¯¯è§£å†³æ–¹æ¡ˆ

## ğŸš¨ é—®é¢˜æè¿°

ç”¨æˆ·åœ¨ä½¿ç”¨æ™ºæ…§ç¤¾åŒºé¡¹ç›®æ—¶é‡åˆ°ä»¥ä¸‹é”™è¯¯ï¼š

```
Failed to load resource: the server responded with a status of 500 (Internal Server Error)
æ·»åŠ å¸‚åœºç‰©å“å¤±è´¥: Error: å‘å¸ƒç‰©å“å¤±è´¥
```

## ğŸ” é—®é¢˜è¯Šæ–­

### é”™è¯¯æ—¥å¿—åˆ†æ

é€šè¿‡æŸ¥çœ‹åç«¯æ—¥å¿—å‘ç°å…·ä½“é”™è¯¯ä¿¡æ¯ï¼š

```
å‘å¸ƒç‰©å“å¤±è´¥: [Error: SQLITE_ERROR: table market_items has no column named image_urls] {
  errno: 1,
  code: 'SQLITE_ERROR'
}
```

### æ ¹æœ¬åŸå› 

æ•°æ®åº“è¡¨ç»“æ„ä¸å®Œæ•´ï¼Œ`market_items` è¡¨ç¼ºå°‘ `image_urls` åˆ—ï¼Œå¯¼è‡´åœ¨å‘å¸ƒå¸‚åœºç‰©å“æ—¶å‡ºç°SQLé”™è¯¯ã€‚

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### 1. ç«‹å³ä¿®å¤

**æ­¥éª¤1ï¼šæ·»åŠ ç¼ºå¤±çš„æ•°æ®åº“åˆ—**

```bash
# è¿›å…¥åç«¯ç›®å½•
cd backend

# æ·»åŠ image_urlsåˆ—
sqlite3 data/community.db "ALTER TABLE market_items ADD COLUMN image_urls TEXT;"

# éªŒè¯ä¿®å¤
sqlite3 data/community.db ".schema market_items"
```

**æ­¥éª¤2ï¼šé‡å¯æœåŠ¡**

```bash
# è¿”å›é¡¹ç›®æ ¹ç›®å½•
cd ..

# é‡å¯å¤–éƒ¨è®¿é—®æœåŠ¡
./external-manager.sh restart
```

### 2. ä½¿ç”¨æ•°æ®åº“ä¿®å¤è„šæœ¬

æˆ‘ä»¬æä¾›äº†ä¸“é—¨çš„æ•°æ®åº“ä¿®å¤è„šæœ¬ï¼š

```bash
# æ£€æŸ¥æ•°æ®åº“ç»“æ„
./fix-database.sh --check

# ä¿®å¤æ•°æ®åº“ç»“æ„ï¼ˆä¼šè‡ªåŠ¨å¤‡ä»½ï¼‰
./fix-database.sh --fix

# ä»…å¤‡ä»½æ•°æ®åº“
./fix-database.sh --backup
```

## ğŸ“‹ éªŒè¯ä¿®å¤

### 1. æ£€æŸ¥è¡¨ç»“æ„

```bash
cd backend
sqlite3 data/community.db ".schema market_items"
```

åº”è¯¥çœ‹åˆ°åŒ…å« `image_urls TEXT` çš„å®Œæ•´è¡¨ç»“æ„ã€‚

### 2. æµ‹è¯•APIåŠŸèƒ½

```bash
./external-manager.sh test
```

### 3. å‰ç«¯åŠŸèƒ½æµ‹è¯•

1. è®¿é—® `http://123.56.64.5:5173`
2. ç™»å½•ä»»æ„æ¼”ç¤ºè´¦æˆ·
3. è¿›å…¥"é—²ç½®å¸‚åœº"é¡µé¢
4. å°è¯•å‘å¸ƒæ–°ç‰©å“
5. ç¡®è®¤å¯ä»¥æˆåŠŸä¸Šä¼ å›¾ç‰‡å’Œå‘å¸ƒç‰©å“

## ğŸ”§ é¢„é˜²æªæ–½

### 1. æ•°æ®åº“ç‰ˆæœ¬ç®¡ç†

ä¸ºé¿å…ç±»ä¼¼é—®é¢˜ï¼Œå»ºè®®ï¼š

- å®šæœŸå¤‡ä»½æ•°æ®åº“
- ä½¿ç”¨æ•°æ®åº“è¿ç§»è„šæœ¬
- åœ¨éƒ¨ç½²å‰æ£€æŸ¥è¡¨ç»“æ„

### 2. å®šæœŸç»´æŠ¤

```bash
# æ¯å‘¨è¿è¡Œä¸€æ¬¡æ•°æ®åº“æ£€æŸ¥
./fix-database.sh --check

# æ¯æœˆå¤‡ä»½ä¸€æ¬¡æ•°æ®åº“
./fix-database.sh --backup
```

### 3. ç›‘æ§å’Œæ—¥å¿—

- å®šæœŸæŸ¥çœ‹åç«¯æ—¥å¿—ï¼š`./external-manager.sh logs backend`
- ç›‘æ§æœåŠ¡çŠ¶æ€ï¼š`./external-manager.sh status`
- æµ‹è¯•APIåŠŸèƒ½ï¼š`./external-manager.sh test`

## ğŸ“Š æŠ€æœ¯ç»†èŠ‚

### æ•°æ®åº“è¡¨ç»“æ„å˜æ›´

**ä¿®å¤å‰çš„è¡¨ç»“æ„ï¼š**
```sql
CREATE TABLE market_items (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  description TEXT NOT NULL,
  price REAL NOT NULL,
  category TEXT NOT NULL,
  image_url TEXT,
  seller TEXT NOT NULL,
  seller_user_id TEXT,
  posted_date DATETIME NOT NULL,
  contact_info TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (seller_user_id) REFERENCES users(id)
);
```

**ä¿®å¤åçš„è¡¨ç»“æ„ï¼š**
```sql
CREATE TABLE market_items (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  description TEXT NOT NULL,
  price REAL NOT NULL,
  category TEXT NOT NULL,
  image_url TEXT,
  seller TEXT NOT NULL,
  seller_user_id TEXT,
  posted_date DATETIME NOT NULL,
  contact_info TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  image_urls TEXT,  -- æ–°å¢ï¼šæ”¯æŒå¤šå›¾ç‰‡çš„JSONå­—ç¬¦ä¸²
  FOREIGN KEY (seller_user_id) REFERENCES users(id)
);
```

### ä»£ç é€»è¾‘

åç«¯ä»£ç æœŸæœ› `image_urls` åˆ—å­˜å‚¨JSONæ ¼å¼çš„å›¾ç‰‡URLæ•°ç»„ï¼š

```typescript
// æ„å»ºå›¾ç‰‡URLæ•°ç»„
const imageUrls = uploadedFiles.map(file => `/uploads/${file.filename}`);
const imageUrlsJson = JSON.stringify(imageUrls);

// æ’å…¥æ•°æ®åº“
db.run(
  `INSERT INTO market_items (..., image_urls, ...)
   VALUES (..., ?, ...)`,
  [..., imageUrlsJson, ...]
);
```

## ğŸ¯ ç›¸å…³å·¥å…·

### 1. æ•°æ®åº“ä¿®å¤è„šæœ¬

- **æ–‡ä»¶**: `fix-database.sh`
- **åŠŸèƒ½**: æ£€æŸ¥å’Œä¿®å¤æ•°æ®åº“è¡¨ç»“æ„
- **ç”¨æ³•**: `./fix-database.sh --help`

### 2. å¤–éƒ¨è®¿é—®ç®¡ç†è„šæœ¬

- **æ–‡ä»¶**: `external-manager.sh`
- **åŠŸèƒ½**: ç»Ÿä¸€ç®¡ç†æœåŠ¡å¯åŠ¨ã€åœæ­¢ã€çŠ¶æ€æ£€æŸ¥
- **ç”¨æ³•**: `./external-manager.sh help`

### 3. æ—¥å¿—æŸ¥çœ‹

```bash
# æŸ¥çœ‹åç«¯æ—¥å¿—
./external-manager.sh logs backend

# æŸ¥çœ‹å‰ç«¯æ—¥å¿—
./external-manager.sh logs frontend

# æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
./external-manager.sh logs
```

## ğŸš€ å¿«é€Ÿæ¢å¤æŒ‡å—

å¦‚æœå†æ¬¡é‡åˆ°ç±»ä¼¼é—®é¢˜ï¼š

1. **ç«‹å³è¯Šæ–­**ï¼š
   ```bash
   ./external-manager.sh logs backend | tail -20
   ```

2. **æ£€æŸ¥æ•°æ®åº“**ï¼š
   ```bash
   ./fix-database.sh --check
   ```

3. **ä¿®å¤é—®é¢˜**ï¼š
   ```bash
   ./fix-database.sh --fix
   ```

4. **é‡å¯æœåŠ¡**ï¼š
   ```bash
   ./external-manager.sh restart
   ```

5. **éªŒè¯ä¿®å¤**ï¼š
   ```bash
   ./external-manager.sh test
   ```

## ğŸ“ è”ç³»æ”¯æŒ

å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. é”™è¯¯æ—¥å¿—ï¼š`./external-manager.sh logs backend`
2. æœåŠ¡çŠ¶æ€ï¼š`./external-manager.sh status`
3. æ•°æ®åº“ç»“æ„ï¼š`./fix-database.sh --check`
4. å…·ä½“æ“ä½œæ­¥éª¤å’Œé”™è¯¯æˆªå›¾

---

**âœ… é—®é¢˜å·²è§£å†³ï¼ç°åœ¨æ‚¨å¯ä»¥æ­£å¸¸ä½¿ç”¨å¸‚åœºç‰©å“å‘å¸ƒåŠŸèƒ½äº†ã€‚** 