# 身份证明材料查看功能

## 功能概述

管理员可以在用户管理页面查看用户上传的身份证明材料，支持多种文件格式的预览和下载。

## 支持的文件格式

### 图片格式
- **JPG/JPEG** - 直接在模态框中预览
- **PNG** - 直接在模态框中预览  
- **GIF** - 直接在模态框中预览
- **BMP** - 直接在模态框中预览
- **WEBP** - 直接在模态框中预览

### 文档格式
- **PDF** - 在iframe中预览，支持在新窗口打开
- **其他格式** - 提供下载链接

## 功能特性

### 1. 用户信息展示
- 用户姓名和ID
- 楼栋、单元、房间信息
- 认证状态（已认证/未认证）
- 认证时间（如果已认证）

### 2. 文件信息展示
- 文件名和类型
- 文件路径
- 文件格式标识图标

### 3. 文件预览功能
- **图片文件**：高质量预览，支持缩放
- **PDF文件**：内嵌iframe预览
- **其他文件**：显示文件信息和下载选项

### 4. 错误处理
- 图片加载失败时显示错误提示
- 提供文件URL用于调试
- 网络连接问题的友好提示

### 5. 操作功能
- 在新窗口打开文件
- 直接下载文件
- 关闭模态框

## 使用方法

### 管理员操作步骤

1. **登录管理员账户**
   - 使用管理员权限的账户登录系统

2. **进入用户管理页面**
   - 点击管理后台的"用户管理"标签

3. **查看身份证明材料**
   - 在用户列表中找到目标用户
   - 在"证明材料"列中点击"查看"按钮
   - 如果用户未上传材料，会显示"未上传"

4. **在模态框中查看文件**
   - 查看用户基本信息
   - 预览上传的文件内容
   - 使用操作按钮进行进一步操作

## 技术实现

### 前端组件
- **IdentityImageModal.tsx** - 身份证明材料查看模态框
- **UserManagementTab.tsx** - 用户管理主页面

### 文件URL构建
```typescript
const getFileUrl = (path: string): string => {
  // 如果路径已经是完整URL，直接返回
  if (path.startsWith('http')) {
    return path;
  }
  
  // 构建基于当前主机的URL
  const baseUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
    ? 'http://localhost:3000'
    : `http://${window.location.hostname}:3000`;
  
  // 确保路径以/开头
  const normalizedPath = path.startsWith('/') ? path : `/${path}`;
  
  return `${baseUrl}${normalizedPath}`;
};
```

### 文件类型检测
```typescript
// 获取文件扩展名
const getFileExtension = (filename: string): string => {
  return filename.split('.').pop()?.toLowerCase() || '';
};

// 判断是否为图片文件
const isImageFile = (filename: string): boolean => {
  const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'];
  return imageExtensions.includes(getFileExtension(filename));
};

// 判断是否为PDF文件
const isPdfFile = (filename: string): boolean => {
  return getFileExtension(filename) === 'pdf';
};
```

## 数据库结构

### users表相关字段
```sql
identity_image TEXT,        -- 身份证明材料文件路径
is_verified INTEGER DEFAULT 0,  -- 认证状态 (0=未认证, 1=已认证)
verified_at DATETIME,       -- 认证时间
verified_by TEXT           -- 认证操作者
```

## 文件存储

### 上传目录
- **路径**: `backend/uploads/`
- **命名规则**: `identity-{timestamp}-{random}.{extension}`
- **示例**: `identity-1748941817030-396760285.PNG`

### 访问URL
- **本地开发**: `http://localhost:3000/uploads/{filename}`
- **生产环境**: `http://{domain}:3000/uploads/{filename}`

## 安全考虑

### 权限控制
- 只有管理员可以查看身份证明材料
- 用户只能上传，不能查看其他用户的材料

### 文件类型限制
- 后端限制上传文件类型：JPEG、PNG、PDF
- 前端根据文件扩展名判断预览方式

### 文件大小限制
- 最大文件大小：5MB
- 在multer配置中设置

## 故障排除

### 常见问题

1. **图片无法显示**
   - 检查文件是否存在于 `backend/uploads/` 目录
   - 确认后端服务正常运行
   - 检查CORS配置是否正确

2. **PDF无法预览**
   - 确认浏览器支持PDF预览
   - 检查文件是否损坏
   - 尝试在新窗口打开

3. **文件路径错误**
   - 检查数据库中的 `identity_image` 字段
   - 确认路径格式正确（以/uploads/开头）

### 调试信息
- 模态框中显示完整的文件路径
- 浏览器控制台会显示加载错误
- 网络面板可以查看HTTP请求状态

## 测试用例

### 测试数据
数据库中已有测试用户：
- `user1` - 张三，有SVG格式证明材料
- `user2` - 李四，有SVG格式证明材料  
- `user1748941817140` - 121，有PNG格式证明材料

### 测试步骤
1. 登录管理员账户 (`superadmin@example.com` / `admin`)
2. 进入用户管理页面
3. 点击有证明材料的用户的"查看"按钮
4. 验证模态框正确显示用户信息和文件内容
5. 测试"在新窗口打开"功能
6. 测试关闭模态框功能

## 更新日志

### v1.2.0 (2024-12-19)
- ✅ 创建 IdentityImageModal 组件
- ✅ 支持图片和PDF文件预览
- ✅ 添加文件信息展示
- ✅ 实现错误处理机制
- ✅ 添加用户信息展示
- ✅ 支持在新窗口打开文件
- ✅ 修复图标组件兼容性问题

---

**功能状态**: ✅ 已完成  
**测试状态**: ✅ 已测试  
**文档更新**: 2024年12月19日 