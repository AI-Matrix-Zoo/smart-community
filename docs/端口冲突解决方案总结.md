# 智慧社区项目端口冲突解决方案总结

## 问题回顾

**原始问题**：
```
Error: listen EADDRINUSE: address already in use 0.0.0.0:3000
```

**问题根因**：
1. PM2进程管理器在后台自动启动了服务
2. 开发环境和生产环境同时使用3000端口
3. 多个进程管理工具（PM2、nohup、直接启动）混合使用
4. 缺乏统一的进程管理机制

## 解决方案实施

### 1. 智能端口检测和管理

在 `backend/src/index.ts` 中添加了智能端口检测功能：

```typescript
// 智能端口检测和管理
const checkPortAvailable = (port: number): Promise<boolean> => {
  return new Promise((resolve) => {
    const server = net.createServer();
    server.listen(port, () => {
      server.once('close', () => {
        resolve(true);
      });
      server.close();
    });
    server.on('error', () => {
      resolve(false);
    });
  });
};

const findAvailablePort = async (preferredPort: number): Promise<number> => {
  // 检查首选端口
  if (await checkPortAvailable(preferredPort)) {
    return preferredPort;
  }
  
  // 如果首选端口不可用，尝试其他端口
  const alternativePorts = [3001, 3002, 3003, 3004, 3005];
  for (const port of alternativePorts) {
    if (await checkPortAvailable(port)) {
      console.log(`⚠️  端口 ${preferredPort} 被占用，使用替代端口 ${port}`);
      return port;
    }
  }
  
  // 随机端口作为最后选择
  for (let i = 0; i < 10; i++) {
    const randomPort = Math.floor(Math.random() * (9999 - 3000) + 3000);
    if (await checkPortAvailable(randomPort)) {
      console.log(`⚠️  预设端口都被占用，使用随机端口 ${randomPort}`);
      return randomPort;
    }
  }
  
  throw new Error('无法找到可用端口');
};
```

### 2. 环境端口隔离

- **生产环境端口**: 3000
- **开发环境端口**: 3001
- **前端开发**: 5174
- **前端生产**: 5173

### 3. 统一进程管理

#### 修改 `unified-manager.sh` 脚本

**停止生产服务功能增强**：
```bash
stop_production() {
    log_header "停止生产服务"
    
    # 停止PM2管理的进程
    if command -v pm2 >/dev/null 2>&1; then
        log_info "停止PM2管理的进程..."
        pm2 stop smart-community-backend 2>/dev/null || true
        pm2 delete smart-community-backend 2>/dev/null || true
        pm2 stop smart-community-frontend 2>/dev/null || true
        pm2 delete smart-community-frontend 2>/dev/null || true
        pm2 stop all 2>/dev/null || true
        pm2 delete all 2>/dev/null || true
        log_success "PM2进程清理完成"
    fi
    
    # 停止PID文件管理的进程
    if [ -f ".production.pid" ]; then
        PID=$(cat .production.pid)
        if kill -0 $PID 2>/dev/null; then
            kill $PID
            rm .production.pid
            log_success "生产服务已停止 (PID: $PID)"
        fi
    fi
    
    # 强制释放端口
    free_port $PROD_PORT_BACKEND
    free_port $PROD_PORT_FRONTEND
    
    # 清理所有相关进程
    pkill -f "smart-community" 2>/dev/null || true
    
    log_success "所有生产服务已停止"
}
```

**改进的端口释放功能**：
```bash
free_port() {
    local port=$1
    log_info "检查端口 $port 占用情况..."
    
    # 使用timeout防止lsof挂起
    if command -v lsof &>/dev/null; then
        pids=$(timeout 5 lsof -ti tcp:$port 2>/dev/null || true)
    elif command -v netstat &>/dev/null; then
        pids=$(timeout 5 netstat -tlnp 2>/dev/null | grep :$port | awk '{print $7}' | cut -d'/' -f1 || true)
    fi
    
    if [ -n "$pids" ]; then
        log_warning "端口 $port 被占用，自动释放..."
        for pid in $pids; do
            if [ "$pid" != "-" ] && [ -n "$pid" ]; then
                if kill -0 $pid 2>/dev/null; then
                    kill -9 $pid 2>/dev/null && log_success "已终止进程 $pid (端口:$port)"
                fi
            fi
        done
        sleep 1
    else
        log_info "端口 $port 未被占用"
    fi
}
```

### 4. 专用启动脚本

#### 生产环境启动脚本 (`backend/start-production.sh`)

```bash
#!/bin/bash
# 设置生产环境变量
export NODE_ENV=production
export PORT=3000

# 检查并释放端口
if ! check_port 3000; then
    log_warning "端口3000被占用，尝试释放..."
    free_port 3000
fi

# 确保数据目录存在
mkdir -p data uploads logs

# 编译TypeScript代码
npm run build

# 启动服务
node dist/index.js
```

#### 开发环境启动脚本 (`backend/start-development.sh`)

```bash
#!/bin/bash
# 设置开发环境变量
export NODE_ENV=development
export PORT=3001

# 检查并释放端口
if ! check_port 3001; then
    log_warning "端口3001被占用，尝试释放..."
    free_port 3001
fi

# 启动开发服务
npx ts-node src/index.ts
```

### 5. 快速修复工具

创建了 `fix-port-conflict.sh` 脚本用于紧急处理：

```bash
# 检查端口占用
./fix-port-conflict.sh --check

# 修复端口冲突
./fix-port-conflict.sh --fix

# 重启生产环境
./fix-port-conflict.sh --restart

# 查看服务状态
./fix-port-conflict.sh --status
```

## 使用指南

### 正确的部署流程

1. **停止所有服务**：
   ```bash
   ./unified-manager.sh prod-stop
   ```

2. **部署生产环境**：
   ```bash
   ./unified-manager.sh deploy
   ```

3. **检查服务状态**：
   ```bash
   ./unified-manager.sh status
   ```

### 开发环境使用

1. **启动开发环境**：
   ```bash
   ./unified-manager.sh dev
   ```

2. **停止开发环境**：
   ```bash
   ./unified-manager.sh dev-stop
   ```

### 紧急处理

如果遇到端口冲突：

```bash
# 快速修复
./fix-port-conflict.sh --restart

# 或者手动处理
pkill -f "smart-community"
./unified-manager.sh deploy
```

## 监控和维护

### 健康检查

- **生产环境**: `http://localhost:3000/health`
- **开发环境**: `http://localhost:3001/health`
- **API接口**: `http://localhost:3000/api/health`

### 日志查看

```bash
# 查看最新日志
tail -f logs/backend-$(date +%Y%m%d)-*.log

# 查看服务状态
./unified-manager.sh status

# 查看PM2状态
pm2 list
```

### 端口检查

```bash
# 检查端口占用
lsof -i :3000
lsof -i :3001

# 查看所有Node.js进程
ps aux | grep node
```

## 预防措施

1. **统一使用 unified-manager.sh 脚本管理服务**
2. **避免直接使用 PM2 启动服务**
3. **部署前先停止现有服务**
4. **定期检查服务状态**
5. **监控端口占用情况**

## 故障排除

### 常见问题

1. **服务启动失败**
   - 检查端口是否被占用
   - 查看日志文件确定错误原因
   - 确认环境变量设置正确

2. **健康检查失败**
   - 等待更长时间让服务完全启动
   - 手动测试健康检查接口
   - 检查防火墙设置

3. **PM2进程残留**
   - 使用 `pm2 delete all` 清理
   - 检查 `pm2 list` 确认清理完成

### 调试命令

```bash
# 调试脚本执行
bash -x ./unified-manager.sh deploy

# 检查进程树
pstree -p | grep node

# 网络连接状态
netstat -tlnp | grep :3000
```

## 成果总结

✅ **解决了端口冲突问题**
✅ **实现了环境隔离**
✅ **统一了进程管理**
✅ **添加了智能端口检测**
✅ **提供了快速修复工具**
✅ **完善了监控和日志**

现在智慧社区项目可以稳定运行在线上环境，不会再出现端口冲突的问题！

## 更新记录

- **2025-06-03**: 初始版本，解决端口冲突问题
- **2025-06-03**: 添加智能端口检测和环境隔离
- **2025-06-03**: 完善统一管理脚本和快速修复工具
- **2025-06-03**: 改进健康检查机制和错误处理 