# 智慧社区项目端口冲突解决方案

## 问题描述

在线上部署时遇到端口冲突错误：
```
Error: listen EADDRINUSE: address already in use 0.0.0.0:3000
```

## 问题原因

1. **多环境同时运行**：开发环境和生产环境的后端服务同时尝试使用3000端口
2. **端口配置不当**：没有明确区分开发环境和生产环境的端口配置
3. **进程管理混乱**：多个Node.js进程同时运行，导致端口冲突

## 解决方案

### 1. 智能端口检测和管理

在 `backend/src/index.ts` 中添加了智能端口检测功能：

```typescript
// 智能端口检测和管理
const checkPortAvailable = (port: number): Promise<boolean> => {
  return new Promise((resolve) => {
    const server = net.createServer();
    server.listen(port, () => {
      server.once('close', () => {
        resolve(true);
      });
      server.close();
    });
    server.on('error', () => {
      resolve(false);
    });
  });
};

const findAvailablePort = async (preferredPort: number): Promise<number> => {
  // 检查首选端口
  if (await checkPortAvailable(preferredPort)) {
    return preferredPort;
  }
  
  // 如果首选端口不可用，尝试其他端口
  const alternativePorts = [3001, 3002, 3003, 3004, 3005];
  for (const port of alternativePorts) {
    if (await checkPortAvailable(port)) {
      console.log(`⚠️  端口 ${preferredPort} 被占用，使用替代端口 ${port}`);
      return port;
    }
  }
  
  // 如果所有预设端口都被占用，随机选择一个端口
  for (let i = 0; i < 10; i++) {
    const randomPort = Math.floor(Math.random() * (9999 - 3000) + 3000);
    if (await checkPortAvailable(randomPort)) {
      console.log(`⚠️  预设端口都被占用，使用随机端口 ${randomPort}`);
      return randomPort;
    }
  }
  
  throw new Error('无法找到可用端口');
};
```

### 2. 环境端口配置

- **生产环境端口**: 3000
- **开发环境端口**: 3001

### 3. 启动脚本

#### 生产环境启动脚本 (`backend/start-production.sh`)

```bash
#!/bin/bash
# 设置生产环境变量
export NODE_ENV=production
export PORT=3000

# 检查并释放端口
if ! check_port 3000; then
    log_warning "端口3000被占用，尝试释放..."
    free_port 3000
fi

# 启动服务
node dist/index.js
```

#### 开发环境启动脚本 (`backend/start-development.sh`)

```bash
#!/bin/bash
# 设置开发环境变量
export NODE_ENV=development
export PORT=3001

# 检查并释放端口
if ! check_port 3001; then
    log_warning "端口3001被占用，尝试释放..."
    free_port 3001
fi

# 启动服务
npx ts-node src/index.ts
```

## 使用方法

### 生产环境部署

```bash
# 进入后端目录
cd backend

# 编译TypeScript代码
npm run build

# 启动生产环境服务
./start-production.sh
```

### 开发环境启动

```bash
# 进入后端目录
cd backend

# 启动开发环境服务
./start-development.sh
```

### 使用统一管理脚本

```bash
# 启动生产环境
./unified-manager.sh prod

# 启动开发环境
./unified-manager.sh dev
```

## 端口占用检查和处理

### 检查端口占用

```bash
# 检查3000端口
lsof -i :3000

# 检查3001端口
lsof -i :3001
```

### 释放端口

```bash
# 释放3000端口
lsof -ti tcp:3000 | xargs kill -9

# 释放3001端口
lsof -ti tcp:3001 | xargs kill -9
```

### 停止所有相关进程

```bash
# 停止所有smart-community相关进程
pkill -f "smart-community"
```

## 监控和日志

### 健康检查

- 生产环境: `http://localhost:3000/health`
- 开发环境: `http://localhost:3001/health`

### 日志查看

```bash
# 查看后端日志
tail -f backend/logs/app.log

# 查看系统日志
journalctl -u smart-community -f
```

## 预防措施

1. **环境隔离**: 确保开发环境和生产环境使用不同的端口
2. **进程管理**: 使用PM2或systemd管理生产环境进程
3. **自动化部署**: 使用脚本自动检查和处理端口冲突
4. **监控告警**: 设置端口占用监控和告警

## 故障排除

### 常见问题

1. **端口仍然被占用**
   - 检查是否有其他应用使用相同端口
   - 使用 `netstat -tlnp | grep :3000` 查看详细信息

2. **服务启动失败**
   - 检查环境变量是否正确设置
   - 查看错误日志确定具体原因

3. **前端无法连接后端**
   - 确认后端服务正常运行
   - 检查前端配置的API地址是否正确

### 紧急处理

如果遇到紧急端口冲突问题：

```bash
# 1. 停止所有相关进程
pkill -f "smart-community"

# 2. 等待进程完全停止
sleep 3

# 3. 重新启动生产环境
cd backend && ./start-production.sh
```

## 更新记录

- **2024-06-03**: 初始版本，添加智能端口检测和管理功能
- **2024-06-03**: 添加环境隔离和启动脚本
- **2024-06-03**: 完善文档和故障排除指南 