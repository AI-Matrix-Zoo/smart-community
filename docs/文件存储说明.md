# 智慧moma平台文件存储说明

## 文件存储方式

### 1. 存储位置
所有上传的图片和PDF文件都存储在服务器的文件系统中，**不存储在数据库里**。

**存储路径**: `/root/smart-community/backend/uploads/`

### 2. 文件类型和用途

#### 身份证明文件
- **用途**: 用户认证时上传的身份证明材料
- **文件格式**: 支持图片(PNG, JPG, JPEG)和PDF
- **命名规则**: `identity-{timestamp}-{random}.{ext}`
- **示例文件**:
  ```
  identity-1748944339243-522577690.PNG
  identity-1748941817030-396760285.PNG
  identity-1748938375154-798553151.jpeg
  ```

#### 市场物品图片
- **用途**: 闲置物品发布时的商品图片
- **文件格式**: 主要是图片格式
- **存储方式**: 目前演示数据使用外部图片链接，实际上传会存储到uploads目录

### 3. 数据库存储方式

#### 用户表 (users)
```sql
-- 身份证明文件路径存储在 identity_image 字段
identity_image TEXT  -- 存储相对路径，如: /uploads/identity-1748944339243-522577690.PNG
```

#### 市场物品表 (market_items)
```sql
-- 商品图片URL存储在 image_url 字段
image_url TEXT  -- 可以是相对路径或完整URL
```

### 4. 文件访问方式

#### 通过后端API访问
- **URL格式**: `http://123.56.64.5:3000/uploads/{filename}`
- **示例**: `http://123.56.64.5:3000/uploads/identity-1748944339243-522577690.PNG`

#### 通过Nginx反向代理访问
- **URL格式**: `http://123.56.64.5/uploads/{filename}`
- **示例**: `http://123.56.64.5/uploads/identity-1748944339243-522577690.PNG`

### 5. 跨域访问配置

为了支持前端访问上传的文件，已配置：

#### 后端CORS设置
```javascript
// 后端Helmet配置
crossOriginResourcePolicy: { policy: "cross-origin" }

// uploads路径专门的CORS头
app.use('/uploads', (req, res, next) => {
  res.header('Access-Control-Allow-Origin', '*');
  res.header('Cross-Origin-Resource-Policy', 'cross-origin');
  next();
});
```

#### Nginx代理配置
```nginx
# 上传文件代理到后端
location /uploads/ {
    proxy_pass http://127.0.0.1:3000/uploads/;
    # 设置CORS头
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
    add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept";
}
```

### 6. 文件管理

#### 当前存储的文件
```bash
# 查看uploads目录
ls -la /root/smart-community/backend/uploads/

# 文件列表示例:
identity-1748944339243-522577690.PNG  (235KB)
identity-1748941817030-396760285.PNG  (235KB)
identity-1748938375154-798553151.jpeg (277KB)
```

#### 数据库记录
```sql
-- 查看有身份证明文件的用户
SELECT id, name, identity_image, is_verified 
FROM users 
WHERE identity_image IS NOT NULL;

-- 结果示例:
user1748944339350|121|/uploads/identity-1748944339243-522577690.PNG|0
```

### 7. 安全考虑

1. **文件类型限制**: 只允许特定格式的图片和PDF文件
2. **文件大小限制**: 通过Nginx和后端设置最大上传大小
3. **文件名随机化**: 使用时间戳+随机数避免文件名冲突
4. **访问权限**: 管理员可以查看身份证明文件，普通用户只能查看自己的

### 8. 备份建议

重要提醒：`/root/smart-community/backend/uploads/` 目录包含用户的重要身份证明文件，需要定期备份，**不能随意删除**。

---

**最后更新**: 2024年12月19日  
**文件存储路径**: `/root/smart-community/backend/uploads/`  
**访问地址**: `http://123.56.64.5/uploads/` 