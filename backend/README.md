# æ™ºæ…§å°åŒºç”Ÿæ´»å¹³å° - åç«¯API

è¿™æ˜¯æ™ºæ…§å°åŒºç”Ÿæ´»å¹³å°çš„åç«¯APIæœåŠ¡ï¼Œæä¾›ç”¨æˆ·è®¤è¯ã€å»ºè®®åé¦ˆã€äºŒæ‰‹å¸‚åœºã€å…¬å‘Šç®¡ç†ç­‰åŠŸèƒ½ã€‚

## æŠ€æœ¯æ ˆ

- **Node.js** + **TypeScript** - è¿è¡Œæ—¶å’Œå¼€å‘è¯­è¨€
- **Express.js** - Webæ¡†æ¶
- **SQLite** - æ•°æ®åº“
- **JWT** - èº«ä»½è®¤è¯
- **bcryptjs** - å¯†ç åŠ å¯†
- **Joi** - æ•°æ®éªŒè¯

## åŠŸèƒ½ç‰¹æ€§

### ğŸ” ç”¨æˆ·è®¤è¯
- ç”¨æˆ·æ³¨å†Œ/ç™»å½•
- JWT tokenè®¤è¯
- è§’è‰²æƒé™ç®¡ç†ï¼ˆç”¨æˆ·/ç‰©ä¸š/ç®¡ç†å‘˜ï¼‰

### ğŸ’¡ å»ºè®®åé¦ˆ
- æäº¤å»ºè®®
- æŸ¥çœ‹å»ºè®®åˆ—è¡¨
- çŠ¶æ€æ›´æ–°ï¼ˆç‰©ä¸š/ç®¡ç†å‘˜ï¼‰
- è¿›åº¦è·Ÿè¸ª

### ğŸ›’ äºŒæ‰‹å¸‚åœº
- å‘å¸ƒç‰©å“
- æµè§ˆç‰©å“åˆ—è¡¨
- ç®¡ç†ä¸ªäººç‰©å“

### ğŸ“¢ å…¬å‘Šç®¡ç†
- å‘å¸ƒå…¬å‘Šï¼ˆç‰©ä¸š/ç®¡ç†å‘˜ï¼‰
- æŸ¥çœ‹å…¬å‘Šåˆ—è¡¨
- ç¼–è¾‘/åˆ é™¤å…¬å‘Š

### ğŸ‘¥ ç”¨æˆ·ç®¡ç†
- ç”¨æˆ·åˆ—è¡¨ï¼ˆç®¡ç†å‘˜ï¼‰
- ç”¨æˆ·ä¿¡æ¯ç¼–è¾‘
- ç”¨æˆ·åˆ é™¤

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ä½¿ç”¨ç®¡ç†è„šæœ¬ï¼ˆæ¨èï¼‰

æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå¼ºå¤§çš„ç®¡ç†è„šæœ¬ `manage.sh` æ¥ç®€åŒ–å¼€å‘å’Œéƒ¨ç½²æµç¨‹ï¼š

```bash
# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
./manage.sh help

# äº¤äº’å¼èœå•ï¼ˆæ— å‚æ•°è¿è¡Œï¼‰
./manage.sh

# å¸¸ç”¨å‘½ä»¤
./manage.sh install    # å®‰è£…ä¾èµ–
./manage.sh build      # æ„å»ºé¡¹ç›®
./manage.sh dev        # å¯åŠ¨å¼€å‘æœåŠ¡å™¨
./manage.sh start      # å¯åŠ¨ç”Ÿäº§æœåŠ¡å™¨
./manage.sh restart    # é‡å¯æœåŠ¡
./manage.sh status     # æŸ¥çœ‹æœåŠ¡çŠ¶æ€
./manage.sh test-api   # APIæµ‹è¯•
```

### ä¼ ç»Ÿæ–¹å¼

1. **å®‰è£…ä¾èµ–**
   ```bash
   npm install
   ```

2. **ç¯å¢ƒé…ç½®**
   ```bash
   cp env.example .env
   # ç¼–è¾‘ .env æ–‡ä»¶ï¼Œè®¾ç½®å¿…è¦çš„ç¯å¢ƒå˜é‡
   ```

3. **å¯åŠ¨å¼€å‘æœåŠ¡å™¨**
   ```bash
   npm run dev
   ```

4. **æ„å»ºç”Ÿäº§ç‰ˆæœ¬**
   ```bash
   npm run build
   npm start
   ```

## ğŸ› ï¸ ç®¡ç†è„šæœ¬åŠŸèƒ½

### å¼€å‘ç›¸å…³
- `install` - å®‰è£…é¡¹ç›®ä¾èµ–
- `build` - æ„å»ºTypeScripté¡¹ç›®
- `dev` - å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼ˆçƒ­é‡è½½ï¼‰
- `start` - å¯åŠ¨ç”Ÿäº§æœåŠ¡å™¨

### æœåŠ¡ç®¡ç†
- `restart` - é‡å¯ç”Ÿäº§æœåŠ¡ï¼ˆåå°è¿è¡Œï¼‰
- `stop` - åœæ­¢åå°æœåŠ¡
- `status` - æŸ¥çœ‹æœåŠ¡è¿è¡ŒçŠ¶æ€
- `logs` - æŸ¥çœ‹æœåŠ¡æ—¥å¿—

### æµ‹è¯•å’ŒéªŒè¯
- `test` - è¿è¡Œå•å…ƒæµ‹è¯•
- `test-api` - æ‰§è¡ŒAPIç«¯ç‚¹æµ‹è¯•

### æ•°æ®åº“ç®¡ç†
- `database` - æ•°æ®åº“ç®¡ç†èœå•
  - æŸ¥çœ‹æ•°æ®åº“ä¿¡æ¯
  - å¤‡ä»½æ•°æ®åº“
  - æ¢å¤æ•°æ®åº“
  - æ¸…ç©ºæ•°æ®åº“

### ç¯å¢ƒé…ç½®
- `env` - ç¯å¢ƒå˜é‡é…ç½®å’ŒæŸ¥çœ‹

## ğŸ§ª APIæµ‹è¯•

### ä½¿ç”¨ç®¡ç†è„šæœ¬æµ‹è¯•
```bash
# å¯åŠ¨æœåŠ¡å™¨
./manage.sh dev

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯è¿è¡ŒAPIæµ‹è¯•
./manage.sh test-api
```

### ä½¿ç”¨ç‹¬ç«‹æµ‹è¯•è„šæœ¬
```bash
# ç¡®ä¿æœåŠ¡å™¨è¿è¡Œåœ¨3001ç«¯å£
node test-api.js
```

### æ‰‹åŠ¨æµ‹è¯•
```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:3001/health

# è·å–å…¬å‘Šåˆ—è¡¨
curl http://localhost:3001/api/announcements

# æµ‹è¯•ç™»å½•ç«¯ç‚¹
curl -X POST http://localhost:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"phone":"13800138000","password":"password123"}'
```

## ğŸ“¦ Dockeréƒ¨ç½²

### æ„å»ºé•œåƒ
```bash
docker build -t smart-community-backend .
```

### è¿è¡Œå®¹å™¨
```bash
docker run -p 3001:3001 \
  -e JWT_SECRET=your-secret-key \
  -e NODE_ENV=production \
  smart-community-backend
```

## â˜ï¸ Renderéƒ¨ç½²

è¯¦ç»†çš„éƒ¨ç½²æŒ‡å—è¯·å‚è€ƒ [DEPLOYMENT.md](./DEPLOYMENT.md)

### å¿«é€Ÿéƒ¨ç½²æ­¥éª¤
1. å°†ä»£ç æ¨é€åˆ°GitHub
2. åœ¨Renderåˆ›å»ºWeb Service
3. è¿æ¥GitHubä»“åº“
4. Renderä¼šè‡ªåŠ¨æ£€æµ‹`render.yaml`é…ç½®
5. ç­‰å¾…éƒ¨ç½²å®Œæˆ

## APIæ–‡æ¡£

### è®¤è¯æ¥å£

#### POST /api/auth/login
ç”¨æˆ·ç™»å½•
```json
{
  "phone": "13800138000",
  "password": "password123"
}
```

#### POST /api/auth/register
ç”¨æˆ·æ³¨å†Œ
```json
{
  "phone": "13900139000",
  "password": "password123",
  "name": "å¼ ä¸‰",
  "building": "1æ ‹",
  "room": "101"
}
```

### å»ºè®®æ¥å£

#### GET /api/suggestions
è·å–å»ºè®®åˆ—è¡¨ï¼ˆéœ€è¦è®¤è¯ï¼‰

#### POST /api/suggestions
æäº¤æ–°å»ºè®®ï¼ˆéœ€è¦è®¤è¯ï¼‰
```json
{
  "title": "å»ºè®®æ ‡é¢˜",
  "description": "å»ºè®®æè¿°",
  "category": "å»ºè®®åˆ†ç±»"
}
```

#### PUT /api/suggestions/:id/status
æ›´æ–°å»ºè®®çŠ¶æ€ï¼ˆç‰©ä¸š/ç®¡ç†å‘˜ï¼‰
```json
{
  "status": "å¤„ç†ä¸­",
  "progressUpdateText": "æ­£åœ¨å¤„ç†ä¸­..."
}
```

### å¸‚åœºæ¥å£

#### GET /api/market
è·å–å¸‚åœºç‰©å“åˆ—è¡¨

#### POST /api/market
å‘å¸ƒæ–°ç‰©å“ï¼ˆéœ€è¦è®¤è¯ï¼‰
```json
{
  "title": "ç‰©å“æ ‡é¢˜",
  "description": "ç‰©å“æè¿°",
  "price": 100,
  "category": "ç‰©å“åˆ†ç±»",
  "imageUrl": "å›¾ç‰‡URL",
  "contactInfo": "è”ç³»æ–¹å¼"
}
```

### å…¬å‘Šæ¥å£

#### GET /api/announcements
è·å–å…¬å‘Šåˆ—è¡¨

#### POST /api/announcements
å‘å¸ƒå…¬å‘Šï¼ˆç‰©ä¸š/ç®¡ç†å‘˜ï¼‰
```json
{
  "content": "å…¬å‘Šå†…å®¹"
}
```

## ç¯å¢ƒå˜é‡

| å˜é‡å | æè¿° | é»˜è®¤å€¼ |
|--------|------|--------|
| PORT | æœåŠ¡ç«¯å£ | 3001 |
| NODE_ENV | è¿è¡Œç¯å¢ƒ | development |
| JWT_SECRET | JWTå¯†é’¥ | - |
| JWT_EXPIRES_IN | JWTè¿‡æœŸæ—¶é—´ | 7d |
| DB_PATH | æ•°æ®åº“è·¯å¾„ | ./data/community.db |
| FRONTEND_URL | å‰ç«¯URLï¼ˆCORSï¼‰ | http://localhost:5173 |

## æ•°æ®åº“ç»“æ„

### users è¡¨
- id: ç”¨æˆ·ID
- phone: æ‰‹æœºå·
- password: åŠ å¯†å¯†ç 
- name: æ˜¾ç¤ºåç§°
- role: ç”¨æˆ·è§’è‰²
- building: æ¥¼æ ‹
- room: æˆ¿é—´å·

### suggestions è¡¨
- id: å»ºè®®ID
- title: æ ‡é¢˜
- description: æè¿°
- category: åˆ†ç±»
- submitted_by: æäº¤è€…
- status: çŠ¶æ€

### market_items è¡¨
- id: ç‰©å“ID
- title: æ ‡é¢˜
- description: æè¿°
- price: ä»·æ ¼
- category: åˆ†ç±»
- seller: å–å®¶

### announcements è¡¨
- id: å…¬å‘ŠID
- content: å†…å®¹
- author_id: ä½œè€…ID
- role_of_author: ä½œè€…è§’è‰²

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ç«¯å£è¢«å ç”¨**
   ```bash
   # æŸ¥çœ‹ç«¯å£å ç”¨
   lsof -i :3001
   # æˆ–ä½¿ç”¨ç®¡ç†è„šæœ¬
   ./manage.sh status
   ```

2. **ä¾èµ–å®‰è£…å¤±è´¥**
   ```bash
   # æ¸…é™¤ç¼“å­˜é‡æ–°å®‰è£…
   rm -rf node_modules package-lock.json
   npm install
   ```

3. **TypeScriptç¼–è¯‘é”™è¯¯**
   ```bash
   # æ£€æŸ¥TypeScripté…ç½®
   npm run build
   ```

4. **æ•°æ®åº“é—®é¢˜**
   ```bash
   # ä½¿ç”¨ç®¡ç†è„šæœ¬ç®¡ç†æ•°æ®åº“
   ./manage.sh database
   ```

### æ—¥å¿—æŸ¥çœ‹
```bash
# ä½¿ç”¨ç®¡ç†è„šæœ¬æŸ¥çœ‹æ—¥å¿—
./manage.sh logs

# æˆ–ç›´æ¥æŸ¥çœ‹æ–‡ä»¶
tail -f server.log
```

## ğŸ¤ å¼€å‘è´¡çŒ®

- ä½¿ç”¨TypeScriptè¿›è¡Œç±»å‹å®‰å…¨å¼€å‘
- éµå¾ªRESTful APIè®¾è®¡åŸåˆ™
- ä½¿ç”¨Joiè¿›è¡Œè¯·æ±‚æ•°æ®éªŒè¯
- å®ç°äº†å®Œæ•´çš„é”™è¯¯å¤„ç†æœºåˆ¶
- æ”¯æŒCORSè·¨åŸŸè¯·æ±‚

## ï¿½ï¿½ è®¸å¯è¯

MIT License 